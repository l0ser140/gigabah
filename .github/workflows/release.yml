name: Release

on:
  workflow_call:
    inputs:
      parent_run_id:
        description: 'The workflow run ID of the build workflow that triggered this release.'
        required: true
        type: string

jobs:
  compute-version:
    runs-on: ubuntu-latest

    steps:
      - name: Compute version and release type
        id: version
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VER="${GITHUB_REF_NAME}"
            RELEASE="true"
          else
            VER="${GITHUB_SHA::8}"
            RELEASE="true"
          fi
          echo "VER=$VER"
          echo "ver=$VER" >> $GITHUB_OUTPUT
          echo "RELEASE=$RELEASE"
          echo "release=$RELEASE" >> $GITHUB_OUTPUT

          echo Triggered by ${{ inputs.parent_run_id }}

    outputs:
      ver: ${{ steps.version.outputs.ver  }}
      release: ${{ steps.version.outputs.release }}

  release:
    runs-on: ubuntu-latest
    needs: compute-version
    permissions:
      packages: write
      contents: write

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v5
        with:
          run-id: ${{ inputs.parent_run_id }}
          name: build-output
          path: ./.dist
